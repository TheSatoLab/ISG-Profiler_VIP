# ISG-VIP: Viral Infection Predictor

Machine learning-based viral infection prediction using ISG (Interferon-Stimulated Gene) expression profiles.

## Requirements

- Python 3.12
- OpenMP

## Quick Start

### Installation

Get source

```bash
git clone https://github.com/TheSatoLab/ISG-Profiler_VIP.git

cd isg-vip
```

#### Prepare Light GBM

This application requires LightGBM.
If you encounter an OSError like followings, install the OpenMP library:
`OSError: libgomp.so.1: cannot open shared object file: No such file or directory`

```bash
apt-get update && apt-get install -y libgomp1
```

To install dependencies, choose one of the following procedures:

- Install via conda (Recommended if ISG-Profiler installed via conda)
- Create virtual env and install requirements
- Install requirements directly

#### Install via conda

```bash
conda activate isg-profiler

pip install .
```

#### Create virtual env and install requirements:

```bash
# Create virtual env
python -m venv .venv
source .venv/bin/activate

## Update venv pip
pip install --upgrade pip
## then install requirements
pip install .
```

#### Install requirements directly:

```bash
pip install .
```

### Prepare sample files

Following files are required:

- `per_gene_count.tsv`: ISG expression data. Same as ISG-Profiler output `per_gene_count.tsv` (without `--per)
- `sample_metadata.tsv`: Sample metadata. Same as ISG-Profiler input `sample_metadata.tsv`

#### `per_gene_count.tsv` (without `--per)

Same as ISG-Profiler output `per_gene_count.tsv`.
TSV format, with folloing columns and contents:

| Column Header          | Data Type | Description                  |
| :--------------------- | :-------- | :--------------------------- |
| **sample_id**          | String    | Same as ISG-Proflier output. |
| **hum_symbol**         | float     | Same as ISG-Proflier output. |
| **raw_count**          | String    | Same as ISG-Proflier output. |
| **type**               | String    | Same as ISG-Proflier output. |
| **normalized_count**   | String    | Not used in ISG-VIP.         |
| **standardized_count** | String    | Not used in ISG-VIP.         |

#### `sample_metadata.tsv`

Same as ISG-Profiler input `sample_metadata.tsv`.
TSV format, with folloing columns and contents:

| Column Header    | Data Type | Description           |
| :--------------- | :-------- | :-------------------- |
| **sample_id**    | String    | Same as ISG-Proflier. |
| **species_host** | String    | Same as ISG-Proflier. |
| **order_host**   | String    | Same as ISG-Proflier. |
| **clade_host**   | String    | Not used in ISG-VIP.  |

### Execute

```bash
# Runs ISG-VIP using default paths
python -m isg_vip

# Runs ISG-VIP with specific file paths
python -m isg_vip \
  --gene_count_file input/per_gene_count.tsv \
  --metadata input/sample_metadata.tsv \
  --output output
```

#### **isg_vip** Command Line Options

| Option              | Description                              | Default Value               |
| :------------------ | :--------------------------------------- | :-------------------------- |
| `-h, --help`        | Show help message.                       | -                           |
| `--gene_count_file` | per_gene_count.tsv. See README.md file.  | `input/per_gene_count.tsv`  |
| `--metadata`        | sample_metadata.tsv. See README.md file. | `input/sample_metadata.tsv` |
| `--output`          | Output directory.                        | `output`                    |

> [!IMPORTANT] Always verify that your `--gene_count_file` and `--metadata` share the same sample IDs to ensure accurate normalization.

## Outputs

Results written to `--output` (default: `output`):

| File Name                                          | Description                                                                          |
| :------------------------------------------------- | :----------------------------------------------------------------------------------- |
| `Infection_Prediction_{0-4}.csv`                   | Individual fold predictions generated by base models (LightGBM, LogisticRegression). |
| `Infection_Prediction_Stacking_{0-4}_external.csv` | Stacking ensemble results for each specific fold.                                    |
| `Infection_Prediction_Stacking_all.csv`            | All stacking ensemble results from each specific fold results.                       |
| `Infection_Prediction_Stacking_final.csv`          | Final consolidated predictions derived from a 5-fold majority vote.                  |

## Model Architecture

5-fold stacking ensemble:

- Base models: LightGBM + Logistic Regression
- Meta model: LightGBM (trained on base model outputs)
- Final prediction: Majority vote across folds

## Security & Model Integrity

This project uses `pickle` format for trained models. Since loading pickle files can execute arbitrary code, we provide SHA-256 checksums to ensure the files have not been tampered with.

If you want to verify the integrity of the model files, run the following command in the root directory:

```bash
# Verify that the model files match the original checksums
sha256sum -c checksums.sha256
```

## Developer Guide

### Install dependencies

- Python 3.12.x is required.
- For update Python, test by example files and rewrite pyproject.toml

```bash
# Create virtual env
python -m venv .venv
source .venv/bin/activate

# Update pip
pip install --upgrade pip

# Install dependencies
python -m pip install -e ".[dev]"
```

### Dependencis version

When upgrading dependencies, please also pin the ISG-Profiler dependencies to the SAME VERSION.

### Notice for Model Updates

When updating the model, please ensure consistency in the scikit-learn version used during training.

Refer to the pyproject.toml in this repository and pin the scikit-learn dependency to the specific version used for training. The model files are located in the `model_dir` directory.

Additionally, you must update the checksums whenever any files in model_dir/ are added or modified. This allows users to verify that the .pkl files have not been tampered with. To update the checksums.sha256 file, run the following command from the project root:

```bash
find src/isg_vip/model_dir/ -type f \( -name "*.pkl" -o -name "*.npy" \) -exec sha256sum {} + | sort -k 2 > checksums.sha256
```

Always commit the updated `checksums.sha256` alongside the new model files.
